# Скрипт обновления сертификата Letsencrypt в Yandex облаке

## Зачем нужен этот скрипт

Яндекс сам умеет работать с letsencrypt, но при этом необходимо быть владельцем домена и хостить DNS на яндексе, тогда он через dns-challenge - верифицирует овнера домена.

Когда же вы не являетесь овнером домена, а сертификат все же нужен, то появляются подобного рода скрипты.
Кратко: На Yandex ALB опубликован порт 443 и редирект 80 на 443, который форвардит все запросы на внутренний nginx, плюс включена Security Group которая запрещает внешним пользователям коннектится к nginx с недоверенных адресов.
Общий алгоритм можно прочитать из кода, но в кратце он делает следующее:

* Скрипт удаляет листенер с редиректом
* Скрипт создает листенер на порту 80 и отправляет траффик на внутренний nginx
* Скрипт отключает временно секьюрити группу что бы сертбот смог верифицировать домены
* Устанавливается софт + создается виртуальное окружение питона и ставится сертбот
* Сертбот переопределяет папки в локальную папку пользователя - что бы работать под ограниченной учётной записью
* Парсится список доменов из файла domains.txt (т.к. всё происходит в пайплайне Gitlab CI и работа ведется удаленно - файл на удаленную машинку закидывается как domains.txt)
* Выписывает сертификаты
* Обновляет сертификаты в Yandex Certificate
* Обратная последовательность, включение SG, удаление листенера на порту 80 и создание редиректа.

Как уже упоминалось - всё это работает в гитлаб сиай пайплайне по ssh.